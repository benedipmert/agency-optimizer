<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#fafaf9">
<title>Ajans OptimizÃ¶r</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#fafaf9;--surface:#fff;--bg2:#f4f2ef;--surface2:#f0ede9;--surface3:#e8e4de;
  --border:#ebe8e3;--border2:#dcd8d1;
  --text:#18160f;--text2:#7a746a;--text3:#b3aca2;
  --sw:#3b6ef5;--sw-s:#eef2fe;--sw-b:#adc2fb;
  --cr:#8b5cf6;--cr-s:#f3f0fd;--cr-b:#c4b5fd;
  --pm:#0d9e6e;--pm-s:#edfaf4;--pm-b:#6ee7b7;
  --green:#0d9e6e;--green-s:#edfaf4;--green-b:#6ee7b7;
  --amber:#d08000;--amber-s:#fef6e4;--amber-b:#fcd34d;
  --red:#d63a3a;--red-s:#fdf0f0;--red-b:#fca5a5;
  --r:12px;--rsm:8px;--rlg:18px;
  --sh:0 1px 2px rgba(0,0,0,.04),0 2px 8px rgba(0,0,0,.04);
  --shlg:0 4px 24px rgba(0,0,0,.08);
  --f:'Plus Jakarta Sans',-apple-system,sans-serif;
  --nav:66px;--safe:env(safe-area-inset-bottom,0px);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{-webkit-text-size-adjust:100%;}
body{background:var(--bg);color:var(--text);font-family:var(--f);font-size:14px;line-height:1.5;min-height:100dvh;-webkit-font-smoothing:antialiased;}

/* â”€â”€ AUTH â”€â”€ */
#auth-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--bg);padding:20px;}
.auth-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg);padding:36px 32px;width:100%;max-width:380px;box-shadow:var(--shlg);}
.auth-logo{display:flex;align-items:center;gap:10px;margin-bottom:28px;}
.auth-logo-icon{width:38px;height:38px;border-radius:11px;background:var(--sw);display:flex;align-items:center;justify-content:center;color:#fff;font-size:18px;}
.auth-logo h1{font-size:1rem;font-weight:700;}
.auth-logo p{font-size:.7rem;color:var(--text3);}
.auth-title{font-size:1.2rem;font-weight:700;margin-bottom:4px;letter-spacing:-.02em;}
.auth-sub{font-size:.8rem;color:var(--text2);margin-bottom:24px;}
.auth-err{background:var(--red-s);border:1px solid var(--red-b);border-radius:var(--rsm);padding:10px 12px;font-size:.78rem;color:var(--red);margin-bottom:14px;display:none;}
.auth-err.show{display:block;}

/* â”€â”€ SHELL â”€â”€ */
#app-screen{display:none;}
.shell{display:flex;min-height:100vh;}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{width:220px;flex-shrink:0;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;overflow-y:auto;}
.logo{padding:20px 18px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.logo-icon{width:34px;height:34px;border-radius:10px;background:var(--sw);display:flex;align-items:center;justify-content:center;font-size:16px;color:#fff;flex-shrink:0;}
.logo-text h1{font-size:.88rem;font-weight:700;letter-spacing:-.01em;}
.logo-text p{font-size:.65rem;color:var(--text3);margin-top:1px;}
.nav{padding:10px 10px;flex:1;}
.nav-section{padding:10px 10px 4px;font-size:.62rem;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;}
.nav-item{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:var(--rsm);cursor:pointer;color:var(--text2);font-size:.8rem;font-weight:500;transition:all .1s;margin-bottom:1px;}
.nav-item:hover{background:var(--bg2);color:var(--text);}
.nav-item.active{background:var(--sw-s);color:var(--sw);}
.nav-item .ico{width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:.82rem;}
.nav-item.active .ico{background:#fff;}
.nav-bottom{padding:12px;border-top:1px solid var(--border);}
.user-chip{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:var(--rsm);background:var(--bg2);}
.user-avatar{width:28px;height:28px;border-radius:50%;background:var(--sw);color:#fff;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;flex-shrink:0;}
.user-info{flex:1;min-width:0;}
.user-email{font-size:.7rem;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.user-role{font-size:.6rem;color:var(--text3);}
.btn-signout{font-size:.7rem;color:var(--text3);background:none;border:none;cursor:pointer;padding:2px;} .btn-signout:hover{color:var(--red);}

/* â”€â”€ MAIN â”€â”€ */
.main{flex:1;overflow-y:auto;background:var(--bg);}
.page{display:none;padding:28px 28px;max-width:1100px;}
.page.active{display:block;}
.ph{margin-bottom:22px;}
.ph h2{font-size:1.4rem;font-weight:700;letter-spacing:-.02em;}
.ph p{color:var(--text2);font-size:.8rem;margin-top:3px;}

/* â”€â”€ CARDS â”€â”€ */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg);padding:18px 20px;margin-bottom:12px;box-shadow:var(--sh);}
.card-title{font-size:.84rem;font-weight:600;margin-bottom:14px;}
.card-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.card-row .card-title{margin-bottom:0;}

/* â”€â”€ GRIDS â”€â”€ */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}

/* â”€â”€ STAT â”€â”€ */
.stat{background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg);padding:15px 16px;box-shadow:var(--sh);}
.stat .sl{font-size:.62rem;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:4px;}
.stat .sv{font-size:1.5rem;font-weight:700;letter-spacing:-.03em;line-height:1;}
.stat .ss{font-size:.7rem;color:var(--text2);margin-top:3px;}

/* â”€â”€ DEPT CARD â”€â”€ */
.dept-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg);padding:16px 18px;box-shadow:var(--sh);}
.dept-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.dept-name{display:flex;align-items:center;gap:7px;font-weight:600;font-size:.84rem;}
.dd{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.dd.sw{background:var(--sw);}.dd.cr{background:var(--cr);}.dd.pm{background:var(--pm);}

/* â”€â”€ PROGRESS â”€â”€ */
.prog-meta{display:flex;justify-content:space-between;font-size:.7rem;color:var(--text2);margin-bottom:6px;}
.prog-track{height:6px;background:var(--bg2);border-radius:99px;overflow:hidden;}
.prog-fill{height:100%;border-radius:99px;transition:width .5s cubic-bezier(.4,0,.2,1);}
.psw{background:var(--sw);}.pcr{background:var(--cr);}.ppm{background:var(--pm);}
.pwarn{background:var(--amber);}.pfull{background:var(--red);}
.prog-sub{font-size:.7rem;color:var(--text2);margin-top:7px;}

/* â”€â”€ FORMS â”€â”€ */
.form-row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;}
.fg{display:flex;flex-direction:column;gap:5px;flex:1;min-width:130px;}
.fg label{font-size:.7rem;font-weight:600;color:var(--text2);}
.fg input,.fg select{background:var(--bg);border:1.5px solid var(--border);border-radius:var(--rsm);padding:9px 12px;color:var(--text);font-family:var(--f);font-size:.84rem;font-weight:500;outline:none;transition:border-color .12s,box-shadow .12s;width:100%;-webkit-appearance:none;}
.fg input::placeholder{color:var(--text3);font-weight:400;}
.fg input:focus,.fg select:focus{border-color:var(--sw);box-shadow:0 0 0 3px rgba(59,110,245,.1);background:var(--surface);}
.fg select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23b3aca2' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px;}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 18px;border-radius:var(--rsm);border:none;cursor:pointer;font-family:var(--f);font-size:.82rem;font-weight:600;transition:all .12s;white-space:nowrap;-webkit-tap-highlight-color:transparent;}
.bp{background:var(--sw);color:#fff;} .bp:hover{background:#2d5be3;} .bp:active{transform:scale(.97);}
.bg{background:transparent;border:1.5px solid var(--border2);color:var(--text2);padding:6px 10px;font-size:.74rem;}
.bg:hover{border-color:var(--red);color:var(--red);}
.bsm{padding:6px 12px;font-size:.76rem;}

/* â”€â”€ BADGES â”€â”€ */
.badge{display:inline-flex;align-items:center;padding:3px 9px;border-radius:99px;font-size:.66rem;font-weight:600;white-space:nowrap;}
.bsw{background:var(--sw-s);color:var(--sw);}
.bcr{background:var(--cr-s);color:var(--cr);}
.bpm{background:var(--pm-s);color:var(--pm);}
.bok{background:var(--green-s);color:var(--green);}
.bwarn{background:var(--amber-s);color:var(--amber);}
.bfull{background:var(--red-s);color:var(--red);}
.bneu{background:var(--bg2);color:var(--text2);}

/* â”€â”€ TABLE â”€â”€ */
.tw{overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:collapse;font-size:.78rem;}
thead tr{border-bottom:1.5px solid var(--border);}
th{text-align:left;padding:0 11px 9px;font-size:.65rem;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;white-space:nowrap;}
td{padding:10px 11px;border-bottom:1px solid var(--border);vertical-align:middle;}
tbody tr:last-child td{border-bottom:none;}
tbody tr:hover td{background:var(--bg);}

/* â”€â”€ TABS â”€â”€ */
.tab-bar{display:flex;gap:4px;background:var(--bg2);padding:4px;border-radius:var(--r);margin-bottom:16px;width:fit-content;}
.tab{padding:7px 16px;border-radius:8px;border:none;font-family:var(--f);font-size:.78rem;font-weight:600;cursor:pointer;color:var(--text2);background:transparent;transition:all .12s;}
.tab.active{background:var(--surface);color:var(--text);box-shadow:var(--sh);}

/* â”€â”€ OPP CARD â”€â”€ */
.ocard{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--rlg);padding:16px 18px;margin-bottom:10px;box-shadow:var(--sh);position:relative;overflow:hidden;transition:box-shadow .15s;}
.ocard:hover{box-shadow:var(--shlg);}
.ocard-accent{position:absolute;left:0;top:0;bottom:0;width:3.5px;border-radius:99px 0 0 99px;}
.ocard-rank{position:absolute;right:16px;top:14px;font-size:1.5rem;font-weight:800;color:var(--bg2);letter-spacing:-.04em;}
.ocard-name{font-weight:700;font-size:.9rem;margin-bottom:4px;}
.om-grid{display:flex;gap:16px;flex-wrap:wrap;margin-top:12px;}
.om-item .om-l{font-size:.62rem;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.05em;}
.om-item .om-v{font-size:.84rem;font-weight:600;margin-top:2px;}
.sbar{height:3px;background:var(--bg2);border-radius:99px;margin-top:14px;overflow:hidden;}
.sfill{height:100%;background:linear-gradient(90deg,var(--pm),var(--sw));border-radius:99px;}

/* â”€â”€ SECTOR CARD â”€â”€ */
.sec-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;display:flex;align-items:center;gap:12px;margin-bottom:8px;box-shadow:var(--sh);}
.sec-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
.sec-info{flex:1;min-width:0;}
.sec-name{font-weight:600;font-size:.84rem;}
.sec-sub{font-size:.72rem;color:var(--text2);margin-top:2px;}
.sec-val{font-weight:700;font-size:.9rem;text-align:right;}
.sec-pct{font-size:.68rem;color:var(--text2);text-align:right;}

/* â”€â”€ HIGHLIGHT â”€â”€ */
.hbox{border-radius:var(--rlg);padding:16px 18px;margin-bottom:12px;}
.hbox.green{background:var(--green-s);border:1.5px solid var(--green-b);}
.hbox.amber{background:var(--amber-s);border:1.5px solid var(--amber-b);}
.hbox.blue{background:var(--sw-s);border:1.5px solid var(--sw-b);}
.hbox.red{background:var(--red-s);border:1.5px solid var(--red-b);}
.hbox .ht{font-weight:700;font-size:.84rem;margin-bottom:5px;}
.hbox .hb{font-size:.8rem;color:var(--text2);line-height:1.65;}

/* â”€â”€ EUR BADGE â”€â”€ */
.eur{font-size:.62rem;color:var(--text3);background:var(--bg2);border-radius:4px;padding:1px 5px;margin-left:3px;}

/* â”€â”€ EMPTY â”€â”€ */
.empty{text-align:center;padding:32px 20px;color:var(--text3);}
.empty .ei{font-size:2rem;margin-bottom:8px;}
.empty p{font-size:.8rem;}

/* â”€â”€ RATE BAR â”€â”€ */
.rate-bar{background:var(--sw-s);border:1px solid var(--sw-b);border-radius:var(--rsm);padding:8px 14px;display:flex;align-items:center;gap:10px;font-size:.76rem;margin-bottom:16px;flex-wrap:wrap;}
.rate-bar strong{color:var(--sw);}

/* â”€â”€ MOBILE â”€â”€ */
.mobile-nav{display:none;}

@media(max-width:768px){
  .sidebar{display:none;}
  .main{padding-bottom:calc(var(--nav) + var(--safe));}
  .page{padding:16px 14px 8px;}
  .ph h2{font-size:1.2rem;}
  .g4{grid-template-columns:1fr 1fr;}
  .g3{grid-template-columns:1fr;}
  .g2{grid-template-columns:1fr;}
  .form-row{flex-direction:column;}
  .fg{min-width:unset;}
  .fg input,.fg select{font-size:16px;}
  .btn{width:100%;}
  .auth-box{padding:28px 20px;}
  .mobile-nav{display:flex;position:fixed;bottom:0;left:0;right:0;height:calc(var(--nav)+var(--safe));padding-bottom:var(--safe);background:rgba(255,255,255,.92);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--border);z-index:100;}
  .mn-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;cursor:pointer;color:var(--text3);font-size:.56rem;font-weight:600;text-transform:uppercase;letter-spacing:.02em;padding:6px 2px;-webkit-tap-highlight-color:transparent;transition:color .1s;}
  .mn-item.active{color:var(--sw);}
  .mn-item .mi{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1rem;transition:background .1s;}
  .mn-item.active .mi{background:var(--sw-s);}
}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:99px;}
</style>
</head>
<body>

<!-- â•â•â• AUTH â•â•â• -->
<div id="auth-screen">
  <div class="auth-box">
    <div class="auth-logo">
      <div class="auth-logo-icon">â—ˆ</div>
      <div><h1>Ajans OptimizÃ¶r</h1><p>Kaynak & KÃ¢rlÄ±lÄ±k Platformu</p></div>
    </div>
    <div class="auth-title">GiriÅŸ Yap</div>
    <div class="auth-sub">Devam etmek iÃ§in hesabÄ±nÄ±za giriÅŸ yapÄ±n.</div>
    <div class="auth-err" id="auth-err"></div>
    <div class="form-row" style="flex-direction:column;gap:10px">
      <div class="fg"><label>E-posta</label><input type="email" id="a-email" placeholder="ornek@ajans.com" autocomplete="email"></div>
      <div class="fg"><label>Åifre</label><input type="password" id="a-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"></div>
      <button class="btn bp" style="margin-top:4px;width:100%" onclick="signIn()">GiriÅŸ Yap</button>
    </div>
  </div>
</div>

<!-- â•â•â• APP â•â•â• -->
<div id="app-screen">
<div class="shell">

  <!-- SIDEBAR -->
  <nav class="sidebar">
    <div class="logo">
      <div class="logo-icon">â—ˆ</div>
      <div class="logo-text"><h1>Ajans Opt.</h1><p>Kaynak & KÃ¢rlÄ±lÄ±k</p></div>
    </div>
    <div class="nav">
      <div class="nav-section">Genel</div>
      <div class="nav-item active" onclick="go('dashboard',this)"><span class="ico">âŠ</span>Dashboard</div>
      <div class="nav-section">Veri GiriÅŸi</div>
      <div class="nav-item" onclick="go('workforce',this)"><span class="ico">ğŸ‘¥</span>Ä°ÅŸ GÃ¼cÃ¼</div>
      <div class="nav-item" onclick="go('services',this)"><span class="ico">ğŸ“‹</span>Hizmetler</div>
      <div class="nav-item" onclick="go('jobs',this)"><span class="ico">ğŸ—‚</span>Aktif Ä°ÅŸler</div>
      <div class="nav-section">Analiz</div>
      <div class="nav-item" onclick="go('analysis',this)"><span class="ico">ğŸ“ˆ</span>Optimizasyon</div>
      <div class="nav-item" onclick="go('profitability',this)"><span class="ico">ğŸ’°</span>KÃ¢rlÄ±lÄ±k</div>
      <div class="nav-section">Sistem</div>
      <div class="nav-item" onclick="go('settings',this)"><span class="ico">âš™ï¸</span>Ayarlar</div>
    </div>
    <div class="nav-bottom">
      <div class="user-chip">
        <div class="user-avatar" id="user-av">?</div>
        <div class="user-info">
          <div class="user-email" id="user-email">â€”</div>
          <div class="user-role" id="user-role">YÃ¼kleniyorâ€¦</div>
        </div>
        <button class="btn-signout" onclick="signOut()" title="Ã‡Ä±kÄ±ÅŸ">â†©</button>
      </div>
    </div>
  </nav>

  <main class="main">

    <!-- â•â•â• DASHBOARD â•â•â• -->
    <div class="page active" id="page-dashboard">
      <div class="ph"><h2>Dashboard</h2><p>Ajans geneli anlÄ±k Ã¶zet</p></div>
      <div id="rate-bar" class="rate-bar" style="display:none">
        ğŸ’± EUR/TRY: <strong id="rate-display">â€”</strong>
        <span style="color:var(--text3)">|</span>
        Personel maliyetleri Ã—1,3 (sigorta vb.) uygulanmÄ±ÅŸ
        <span id="rate-update" style="color:var(--text3);margin-left:auto;font-size:.7rem"></span>
      </div>

      <div class="g4" style="margin-bottom:14px">
        <div class="stat"><div class="sl">Toplam Kapasite</div><div class="sv" id="d-tcap">0</div><div class="ss">saat/ay</div></div>
        <div class="stat"><div class="sl">KullanÄ±lan</div><div class="sv" id="d-ucap">0</div><div class="ss">saat/ay</div></div>
        <div class="stat"><div class="sl">AylÄ±k Gelir</div><div class="sv" style="color:var(--green)" id="d-rev">â‚¬0</div><div class="ss">aktif iÅŸlerden</div></div>
        <div class="stat"><div class="sl">Net KÃ¢r</div><div class="sv" id="d-profit">â‚¬0</div><div class="ss">gelir âˆ’ maliyet</div></div>
      </div>

      <!-- Dept performance -->
      <div class="g3" style="margin-bottom:14px">
        <div class="dept-card" id="dd-sw">
          <div class="dept-head"><div class="dept-name"><span class="dd sw"></span>YazÄ±lÄ±m</div><span class="badge bsw" id="d-sw-e">0 kiÅŸi</span></div>
          <div class="prog-meta"><span>Doluluk</span><span id="d-sw-p">0%</span></div>
          <div class="prog-track"><div class="prog-fill psw" id="d-sw-b" style="width:0%"></div></div>
          <div class="prog-sub" id="d-sw-i">0 sa boÅŸta</div>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <span style="font-size:.7rem;color:var(--text2)">Gelir: <strong id="d-sw-rev" style="color:var(--sw)">â‚¬0</strong></span>
            <span style="font-size:.7rem;color:var(--text2)">KÃ¢r: <strong id="d-sw-profit">â‚¬0</strong></span>
          </div>
        </div>
        <div class="dept-card" id="dd-cr">
          <div class="dept-head"><div class="dept-name"><span class="dd cr"></span>Kreatif</div><span class="badge bcr" id="d-cr-e">0 kiÅŸi</span></div>
          <div class="prog-meta"><span>Doluluk</span><span id="d-cr-p">0%</span></div>
          <div class="prog-track"><div class="prog-fill pcr" id="d-cr-b" style="width:0%"></div></div>
          <div class="prog-sub" id="d-cr-i">0 sa boÅŸta</div>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <span style="font-size:.7rem;color:var(--text2)">Gelir: <strong id="d-cr-rev" style="color:var(--cr)">â‚¬0</strong></span>
            <span style="font-size:.7rem;color:var(--text2)">KÃ¢r: <strong id="d-cr-profit">â‚¬0</strong></span>
          </div>
        </div>
        <div class="dept-card" id="dd-pm">
          <div class="dept-head"><div class="dept-name"><span class="dd pm"></span>Performans Paz.</div><span class="badge bpm" id="d-pm-e">0 kiÅŸi</span></div>
          <div class="prog-meta"><span>Doluluk</span><span id="d-pm-p">0%</span></div>
          <div class="prog-track"><div class="prog-fill ppm" id="d-pm-b" style="width:0%"></div></div>
          <div class="prog-sub" id="d-pm-i">0 sa boÅŸta</div>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <span style="font-size:.7rem;color:var(--text2)">Gelir: <strong id="d-pm-rev" style="color:var(--pm)">â‚¬0</strong></span>
            <span style="font-size:.7rem;color:var(--text2)">KÃ¢r: <strong id="d-pm-profit">â‚¬0</strong></span>
          </div>
        </div>
      </div>

      <!-- Sector analysis -->
      <div class="g2" style="margin-bottom:14px">
        <div class="card" style="margin-bottom:0">
          <div class="card-title">ğŸ† En KÃ¢rlÄ± Departman & SektÃ¶rler</div>
          <div id="d-best-dept" style="margin-bottom:12px"></div>
          <div id="d-sectors-pos"></div>
        </div>
        <div class="card" style="margin-bottom:0">
          <div class="card-title">âš ï¸ Dikkat: DÃ¼ÅŸÃ¼k KÃ¢r / ZararlÄ±</div>
          <div id="d-worst-dept" style="margin-bottom:12px"></div>
          <div id="d-sectors-neg"></div>
        </div>
      </div>

      <div class="card" style="margin-bottom:0;border-left:3.5px solid var(--sw)">
        <div style="font-size:.68rem;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px">âš¡ AnlÄ±k Ã–neri</div>
        <div id="d-rec" style="font-size:.82rem;color:var(--text2);line-height:1.6">Veri giriÅŸi yapÄ±nca otomatik Ã¶neri gÃ¶rÃ¼nÃ¼r.</div>
      </div>
    </div>

    <!-- â•â•â• WORKFORCE â•â•â• -->
    <div class="page" id="page-workforce">
      <div class="ph"><h2>Ä°ÅŸ GÃ¼cÃ¼</h2><p>Ã‡alÄ±ÅŸanlar, kÄ±demler ve aylÄ±k kapasite â€” maliyet Ã—1,3 (sigorta dahil)</p></div>
      <div class="card">
        <div class="card-title">Yeni Ã‡alÄ±ÅŸan</div>
        <div class="form-row">
          <div class="fg" style="flex:2"><label>Ad Soyad</label><input id="en" placeholder="Ahmet YÄ±lmaz" autocomplete="off"></div>
          <div class="fg"><label>Departman</label>
            <select id="ed"><option value="sw">YazÄ±lÄ±m</option><option value="cr">Kreatif</option><option value="pm">Performans Paz.</option></select>
          </div>
          <div class="fg"><label>KÄ±dem</label><select id="esn" id="esn"></select></div>
          <div class="fg"><label>Kapasite (sa/ay)</label><input type="number" id="ec" value="160" min="1" inputmode="numeric"></div>
          <div class="fg"><label>AylÄ±k Maliyet (â‚º)</label><input type="number" id="ek" placeholder="30000" min="0" inputmode="numeric"></div>
          <div class="fg" style="max-width:100px"><label>&nbsp;</label><button class="btn bp" onclick="addEmp()">+ Ekle</button></div>
        </div>
        <div style="margin-top:10px;font-size:.72rem;color:var(--text3)">* Girilen maliyet Ã—1,3 olarak hesaplanÄ±r (sigorta, yemek vb.)</div>
      </div>
      <div class="card">
        <div class="card-row"><div class="card-title">Ã‡alÄ±ÅŸan Listesi</div><span class="badge bok" id="emp-cnt">0 Ã§alÄ±ÅŸan</span></div>
        <div class="tw"><table>
          <thead><tr><th>Ad Soyad</th><th>Dept.</th><th>KÄ±dem</th><th>Kapasite</th><th>Doluluk</th><th>BrÃ¼t Maliyet â‚º</th><th>GerÃ§ek Maliyet â‚º</th><th>Sa/EUR*</th><th></th></tr></thead>
          <tbody id="emp-tb"><tr><td colspan="9"><div class="empty"><div class="ei">ğŸ‘¥</div><p>HenÃ¼z Ã§alÄ±ÅŸan eklenmedi</p></div></td></tr></tbody>
        </table></div>
        <div style="margin-top:8px;font-size:.68rem;color:var(--text3)">* GÃ¼ncel EUR/TRY kuru Ã¼zerinden hesaplanÄ±r</div>
      </div>
    </div>

    <!-- â•â•â• SERVICES â•â•â• -->
    <div class="page" id="page-services">
      <div class="ph"><h2>Hizmetler</h2><p>Fiyatlar EUR â€” beklenen kÃ¢r = fiyatÄ±n 1/3'Ã¼ Â· gerÃ§ekleÅŸen kÃ¢r saat maliyetine gÃ¶re hesaplanÄ±r</p></div>
      <div class="card">
        <div class="card-title">Yeni Hizmet</div>
        <div class="form-row">
          <div class="fg" style="flex:2"><label>Hizmet AdÄ±</label><input id="sn" placeholder="Google Ads YÃ¶netimi" autocomplete="off"></div>
          <div class="fg"><label>Departman</label>
            <select id="sd"><option value="sw">YazÄ±lÄ±m</option><option value="cr">Kreatif</option><option value="pm">Performans Paz.</option></select>
          </div>
          <div class="fg"><label>AylÄ±k Fiyat (â‚¬)</label><input type="number" id="sp" placeholder="1000" min="0" inputmode="numeric"></div>
          <div class="fg"><label>Gereken Saat/Ay</label><input type="number" id="sh" placeholder="20" min="1" inputmode="numeric"></div>
          <div class="fg" style="max-width:100px"><label>&nbsp;</label><button class="btn bp" onclick="addSvc()">+ Ekle</button></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Hizmet KataloÄŸu</div>
        <div class="tw"><table>
          <thead><tr><th>Hizmet</th><th>Dept.</th><th>Fiyat (â‚¬)</th><th>Beklenen KÃ¢r (â‚¬)</th><th>Saat</th><th>Sa BaÅŸÄ± Gelir</th><th>GerÃ§ekleÅŸen KÃ¢r*</th><th>Marj*</th><th></th></tr></thead>
          <tbody id="svc-tb"><tr><td colspan="9"><div class="empty"><div class="ei">ğŸ“‹</div><p>HenÃ¼z hizmet eklenmedi</p></div></td></tr></tbody>
        </table></div>
        <div style="margin-top:8px;font-size:.68rem;color:var(--text3)">* Ã‡alÄ±ÅŸan maliyeti girilince EUR cinsinden hesaplanÄ±r</div>
      </div>
    </div>

    <!-- â•â•â• JOBS â•â•â• -->
    <div class="page" id="page-jobs">
      <div class="ph"><h2>Aktif Ä°ÅŸler</h2><p>Mevcut mÃ¼ÅŸteri iÅŸleri â€” gelirler EUR Â· sektÃ¶r atamasÄ± yapÄ±labilir</p></div>
      <div class="card">
        <div class="card-title">Yeni Ä°ÅŸ Ekle</div>
        <div class="form-row">
          <div class="fg" style="flex:2"><label>Marka / MÃ¼ÅŸteri</label><input id="jc" placeholder="Mercure Hotel" autocomplete="off"></div>
          <div class="fg"><label>SektÃ¶r</label>
            <select id="jsec">
              <option value="Turizm & Otel">Turizm & Otel</option>
              <option value="E-ticaret">E-ticaret</option>
              <option value="Ä°nÅŸaat & GYO">Ä°nÅŸaat & GYO</option>
              <option value="Tekstil & Moda">Tekstil & Moda</option>
              <option value="GÄ±da & Ä°Ã§ecek">GÄ±da & Ä°Ã§ecek</option>
              <option value="SaÄŸlÄ±k">SaÄŸlÄ±k</option>
              <option value="EÄŸitim">EÄŸitim</option>
              <option value="Teknoloji">Teknoloji</option>
              <option value="Otomotiv">Otomotiv</option>
              <option value="Perakende">Perakende</option>
              <option value="Finans">Finans</option>
              <option value="DiÄŸer">DiÄŸer</option>
            </select>
          </div>
          <div class="fg" style="flex:2"><label>Hizmet</label><select id="js"><option value="">â€” Hizmet SeÃ§ â€”</option></select></div>
          <div class="fg"><label>AylÄ±k Gelir (â‚¬)</label><input type="number" id="jr" placeholder="1000" min="0" inputmode="numeric"></div>
          <div class="fg"><label>Saat/Ay</label><input type="number" id="jh" placeholder="20" min="0" inputmode="numeric"></div>
          <div class="fg" style="max-width:100px"><label>&nbsp;</label><button class="btn bp" onclick="addJob()">+ Ekle</button></div>
        </div>
      </div>
      <div class="card">
        <div class="card-row"><div class="card-title">Aktif Ä°ÅŸ Listesi</div><div id="j-sum" style="font-size:.76rem;color:var(--text2)"></div></div>
        <div class="tw"><table>
          <thead><tr><th>Marka</th><th>SektÃ¶r</th><th>Hizmet</th><th>Dept.</th><th>Gelir (â‚¬)</th><th>Saat/Ay</th><th>KÃ¢r (â‚¬)*</th><th>Marj*</th><th></th></tr></thead>
          <tbody id="job-tb"><tr><td colspan="9"><div class="empty"><div class="ei">ğŸ—‚</div><p>HenÃ¼z iÅŸ eklenmedi</p></div></td></tr></tbody>
        </table></div>
      </div>
    </div>

    <!-- â•â•â• ANALYSIS â•â•â• -->
    <div class="page" id="page-analysis">
      <div class="ph"><h2>Optimizasyon</h2><p>Yeni mÃ¼ÅŸteri fÄ±rsatlarÄ± Â· sÃ¼re optimizasyonu Â· paket Ã¶nerileri</p></div>
      <div class="tab-bar">
        <button class="tab active" onclick="switchAnTab('tekil',this)">ğŸ¯ Tekil FÄ±rsatlar</button>
        <button class="tab" onclick="switchAnTab('blend',this)">ğŸ“¦ Paket FÄ±rsatlar</button>
      </div>
      <div id="an-tekil"></div>
      <div id="an-blend" style="display:none"></div>
    </div>

    <!-- â•â•â• PROFITABILITY â•â•â• -->
    <div class="page" id="page-profitability">
      <div class="ph"><h2>KÃ¢rlÄ±lÄ±k Analizi</h2><p>Hizmet ve sektÃ¶r bazlÄ± kÃ¢r marjlarÄ± â€” EUR cinsinden</p></div>
      <div id="pr-root"></div>
    </div>

    <!-- â•â•â• SETTINGS â•â•â• -->
    <div class="page" id="page-settings">
      <div class="ph"><h2>Ayarlar</h2><p>KÄ±dem seviyeleri, dÃ¶viz kuru ve kullanÄ±cÄ± yÃ¶netimi</p></div>

      <!-- EUR Rate -->
      <div class="card">
        <div class="card-title">ğŸ’± EUR / TRY Kuru</div>
        <div class="form-row" style="align-items:flex-end">
          <div class="fg"><label>Manuel Kur (â‚º)</label><input type="number" id="manual-rate" placeholder="Ã–r: 38.5" min="0" step="0.01" inputmode="decimal"></div>
          <div class="fg" style="max-width:160px"><label>&nbsp;</label><button class="btn bp" onclick="saveManualRate()">Kaydet</button></div>
          <div class="fg" style="max-width:160px"><label>&nbsp;</label><button class="btn bg" onclick="fetchRate()">API'den GÃ¼ncelle</button></div>
        </div>
        <div id="rate-status" style="margin-top:10px;font-size:.76rem;color:var(--text2)"></div>
      </div>

      <!-- Seniority -->
      <div class="card">
        <div class="card-row"><div class="card-title">ğŸ– KÄ±dem Seviyeleri</div><button class="btn bp bsm" onclick="addSeniority()">+ Ekle</button></div>
        <div id="seniority-list"></div>
      </div>

      <!-- Users (admin only) -->
      <div class="card" id="users-card" style="display:none">
        <div class="card-title">ğŸ‘¤ KullanÄ±cÄ± YÃ¶netimi</div>
        <div style="font-size:.8rem;color:var(--text2);margin-bottom:14px">Yeni kullanÄ±cÄ± davet etmek iÃ§in Firebase Authentication konsolunu kullanÄ±n. Rol atamak iÃ§in aÅŸaÄŸÄ±dan dÃ¼zenleyin.</div>
        <div id="users-list"></div>
      </div>
    </div>

  </main>
</div>

<!-- MOBILE NAV -->
<nav class="mobile-nav">
  <div class="mn-item active" onclick="mGo('dashboard',this)"><div class="mi">âŠ</div><span>Ã–zet</span></div>
  <div class="mn-item" onclick="mGo('workforce',this)"><div class="mi">ğŸ‘¥</div><span>Kadro</span></div>
  <div class="mn-item" onclick="mGo('services',this)"><div class="mi">ğŸ“‹</div><span>Hizmet</span></div>
  <div class="mn-item" onclick="mGo('jobs',this)"><div class="mi">ğŸ—‚</div><span>Ä°ÅŸler</span></div>
  <div class="mn-item" onclick="mGo('analysis',this)"><div class="mi">ğŸ“ˆ</div><span>Analiz</span></div>
  <div class="mn-item" onclick="mGo('profitability',this)"><div class="mi">ğŸ’°</div><span>KÃ¢r</span></div>
</nav>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIREBASE CONFIG â€” kendi bilgilerinle doldur
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// Import the functions you need from the SDKs you need
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries
// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyAdmUcRPEu0w4kP-yapr8wHhPIlGt1aE2c",
  authDomain: "agency-optimizer.firebaseapp.com",
  projectId: "agency-optimizer",
  storageBucket: "agency-optimizer.firebasestorage.app",
  messagingSenderId: "265440092392",
  appId: "1:265440092392:web:0e930a4cd6dbe516b6e95d"
};
// Initialize Firebase
const app = initializeApp(firebaseConfig);
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* â•â•â•â• CONSTANTS â•â•â•â• */
const COST_MULTIPLIER = 1.3;
const DEPTS = { sw:'YazÄ±lÄ±m', cr:'Kreatif', pm:'Performans Paz.' };
const DB    = { sw:'bsw', cr:'bcr', pm:'bpm' };
const DEFAULT_SENIORITIES = ['Agent','Junior','Senior','Manager','Senior Manager'];

/* â•â•â•â• STATE â•â•â•â• */
let S = {
  employees:   [],
  services:    [],
  jobs:        [],
  seniorities: [],
  users:       [],
  eurTry:      35.0,
  currentUser: null,
  currentRole: 'user',
};
let unsubs = [];

/* â•â•â•â• HELPERS â•â•â•â• */
const fmtE  = n => 'â‚¬' + new Intl.NumberFormat('tr-TR', {minimumFractionDigits:0,maximumFractionDigits:0}).format(n);
const fmtT  = n => 'â‚º' + new Intl.NumberFormat('tr-TR').format(Math.round(n));
const fmtN  = n => new Intl.NumberFormat('tr-TR').format(Math.round(n));
const pct   = (a,b) => b>0 ? Math.min(Math.round(a/b*100),100) : 0;
const mc    = m => m > 55 ? 'var(--green)' : m > 20 ? 'var(--amber)' : 'var(--red)';
const mcBadge = m => m > 55 ? 'bok' : m > 20 ? 'bwarn' : 'bfull';

// Dept helpers â€” cost includes Ã—1.3
const dCap    = d => S.employees.filter(e=>e.dept===d).reduce((s,e)=>s+e.cap,0);
const dUsed   = d => S.jobs.filter(j=>j.dept===d).reduce((s,j)=>s+j.hrs,0);
const dCostTL = d => S.employees.filter(e=>e.dept===d).reduce((s,e)=>s+(e.costTL*COST_MULTIPLIER),0);
const dCostEUR= d => dCostTL(d) / S.eurTry;
const hrRateTL = d => { const c=dCap(d); return c>0 ? dCostTL(d)/c : 0; };
const hrRateEUR= d => hrRateTL(d) / S.eurTry;
const fCls = (p,d) => p>90?'pfull':p>70?'pwarn':('p'+d);

const seniorityName = id => {
  const s = S.seniorities.find(x => x.id===id);
  return s ? s.name : id || 'â€”';
};

/* â•â•â•â• AUTH â•â•â•â• */
async function signIn() {
  const email = document.getElementById('a-email').value.trim();
  const pass  = document.getElementById('a-pass').value;
  const err   = document.getElementById('auth-err');
  err.classList.remove('show');
  try {
    await auth.signInWithEmailAndPassword(email, pass);
  } catch(e) {
    err.textContent = e.code === 'auth/invalid-credential' || e.code === 'auth/wrong-password'
      ? 'E-posta veya ÅŸifre hatalÄ±.' : e.message;
    err.classList.add('show');
  }
}
async function signOut() {
  unsubs.forEach(u=>u()); unsubs=[];
  await auth.signOut();
}
document.getElementById('a-pass').addEventListener('keydown', e => { if(e.key==='Enter') signIn(); });

auth.onAuthStateChanged(async user => {
  if (!user) {
    document.getElementById('auth-screen').style.display = 'flex';
    document.getElementById('app-screen').style.display  = 'none';
    return;
  }
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app-screen').style.display  = 'block';

  S.currentUser = user;
  document.getElementById('user-email').textContent = user.email;
  document.getElementById('user-av').textContent = user.email.charAt(0).toUpperCase();

  // Load user role
  const userDoc = await db.collection('users').doc(user.uid).get();
  if (!userDoc.exists) {
    await db.collection('users').doc(user.uid).set({ email:user.email, role:'user' });
    S.currentRole = 'user';
  } else {
    S.currentRole = userDoc.data().role || 'user';
  }
  document.getElementById('user-role').textContent = S.currentRole === 'admin' ? 'YÃ¶netici' : 'KullanÄ±cÄ±';
  if (S.currentRole === 'admin') {
    document.getElementById('users-card').style.display = 'block';
  }

  startListeners();
  fetchRate();
});

/* â•â•â•â• FIRESTORE LISTENERS â•â•â•â• */
function startListeners() {
  unsubs.push(
    db.collection('seniorities').orderBy('order').onSnapshot(snap => {
      S.seniorities = snap.docs.map(d=>({id:d.id,...d.data()}));
      if (!S.seniorities.length) seedSeniorities();
      renderSeniorities(); updateSenioritySelect();
    }),
    db.collection('employees').orderBy('name').onSnapshot(snap => {
      S.employees = snap.docs.map(d=>({id:d.id,...d.data()}));
      renderEmps(); renderDash();
    }),
    db.collection('services').orderBy('name').onSnapshot(snap => {
      S.services = snap.docs.map(d=>({id:d.id,...d.data()}));
      renderSvcs(); syncJobSvcSelect();
    }),
    db.collection('jobs').orderBy('client').onSnapshot(snap => {
      S.jobs = snap.docs.map(d=>({id:d.id,...d.data()}));
      renderJobs(); renderDash();
    }),
    db.collection('settings').doc('global').onSnapshot(snap => {
      if (snap.exists) {
        const d = snap.data();
        if (d.eurTry) { S.eurTry = d.eurTry; updateRateDisplay(); }
      }
    })
  );
  if (S.currentRole==='admin') {
    unsubs.push(
      db.collection('users').onSnapshot(snap => {
        S.users = snap.docs.map(d=>({id:d.id,...d.data()}));
        renderUsers();
      })
    );
  }
}

/* â•â•â•â• EUR RATE â•â•â•â• */
async function fetchRate() {
  document.getElementById('rate-status').textContent = 'Kur gÃ¼ncelleniyorâ€¦';
  try {
    const r = await fetch('https://api.frankfurter.app/latest?from=EUR&to=TRY');
    if (!r.ok) throw new Error('API hatasÄ±');
    const d = await r.json();
    const rate = d.rates.TRY;
    await db.collection('settings').doc('global').set({ eurTry: rate, rateUpdated: new Date().toISOString() }, { merge:true });
    document.getElementById('rate-status').textContent = `âœ“ Kur gÃ¼ncellendi: ${rate.toFixed(2)} â‚º/â‚¬`;
  } catch(e) {
    document.getElementById('rate-status').textContent = 'âš  API\'ye ulaÅŸÄ±lamadÄ±. Manuel kur kullanÄ±lÄ±yor.';
  }
}
async function saveManualRate() {
  const v = parseFloat(document.getElementById('manual-rate').value);
  if (!v || v <= 0) { alert('GeÃ§erli bir kur girin'); return; }
  await db.collection('settings').doc('global').set({ eurTry:v, rateUpdated: 'Manuel' }, { merge:true });
  document.getElementById('rate-status').textContent = `âœ“ Manuel kur kaydedildi: ${v} â‚º/â‚¬`;
}
function updateRateDisplay() {
  document.getElementById('rate-bar').style.display = 'flex';
  document.getElementById('rate-display').textContent = `${S.eurTry.toFixed(2)} â‚º`;
  document.getElementById('rate-update').textContent = '';
  document.getElementById('manual-rate').placeholder = S.eurTry.toFixed(2);
}

/* â•â•â•â• SENIORITIES â•â•â•â• */
async function seedSeniorities() {
  const batch = db.batch();
  DEFAULT_SENIORITIES.forEach((name,i) => {
    const ref = db.collection('seniorities').doc();
    batch.set(ref, { name, order:i });
  });
  await batch.commit();
}
function updateSenioritySelect() {
  const sel = document.getElementById('esn');
  if (!sel) return;
  const cur = sel.value;
  sel.innerHTML = S.seniorities.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
  if (cur) sel.value = cur;
}
function renderSeniorities() {
  const el = document.getElementById('seniority-list');
  if (!el) return;
  if (!S.seniorities.length) { el.innerHTML = '<div class="empty"><p>KÄ±dem eklenmedi</p></div>'; return; }
  el.innerHTML = S.seniorities.map((s,i) => `
    <div style="display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--border);">
      <span class="badge bneu" style="min-width:24px;justify-content:center">${i+1}</span>
      <input value="${s.name}" id="sname-${s.id}" style="flex:1;background:var(--bg);border:1.5px solid var(--border);border-radius:var(--rsm);padding:7px 10px;font-family:var(--f);font-size:.82rem;outline:none" 
        onchange="renameSeniority('${s.id}',this.value)">
      <button class="btn bg" style="padding:5px 10px;font-size:.7rem" onclick="deleteSeniority('${s.id}')">âœ•</button>
    </div>`).join('');
}
async function addSeniority() {
  const name = prompt('KÄ±dem adÄ±:');
  if (!name) return;
  await db.collection('seniorities').add({ name: name.trim(), order: S.seniorities.length });
}
async function renameSeniority(id, name) {
  await db.collection('seniorities').doc(id).update({ name });
}
async function deleteSeniority(id) {
  if (!confirm('Bu kÄ±dem silinsin mi?')) return;
  await db.collection('seniorities').doc(id).delete();
}

/* â•â•â•â• USERS â•â•â•â• */
function renderUsers() {
  const el = document.getElementById('users-list'); if(!el) return;
  if (!S.users.length) { el.innerHTML='<div class="empty"><p>KullanÄ±cÄ± yok</p></div>'; return; }
  el.innerHTML = S.users.map(u => `
    <div style="display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--border)">
      <div style="flex:1">
        <div style="font-weight:600;font-size:.82rem">${u.email}</div>
        <div style="font-size:.68rem;color:var(--text3)">${u.id}</div>
      </div>
      <select onchange="setUserRole('${u.id}',this.value)" style="border:1.5px solid var(--border);border-radius:var(--rsm);padding:5px 8px;font-family:var(--f);font-size:.76rem;background:var(--bg)">
        <option value="user" ${u.role!=='admin'?'selected':''}>KullanÄ±cÄ±</option>
        <option value="admin" ${u.role==='admin'?'selected':''}>YÃ¶netici</option>
      </select>
    </div>`).join('');
}
async function setUserRole(uid, role) {
  await db.collection('users').doc(uid).update({ role });
}

/* â•â•â•â• NAVIGATION â•â•â•â• */
function go(page, el) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  if (el) el.classList.add('active');
  if (page==='dashboard')    renderDash();
  if (page==='analysis')     { renderAnTekil(); renderAnBlend(); }
  if (page==='profitability') renderPr();
  if (page==='jobs')         syncJobSvcSelect();
  window.scrollTo(0,0);
}
function mGo(page, el) {
  document.querySelectorAll('.mn-item').forEach(n=>n.classList.remove('active'));
  el.classList.add('active');
  go(page, null);
}
function switchAnTab(tab, el) {
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('an-tekil').style.display = tab==='tekil'?'block':'none';
  document.getElementById('an-blend').style.display = tab==='blend'?'block':'none';
}

/* â•â•â•â• EMPLOYEES â•â•â•â• */
async function addEmp() {
  const name = document.getElementById('en').value.trim();
  const dept = document.getElementById('ed').value;
  const senId= document.getElementById('esn').value;
  const cap  = parseInt(document.getElementById('ec').value)||0;
  const costTL=parseFloat(document.getElementById('ek').value)||0;
  if (!name||cap<=0) { alert('Ad ve kapasite zorunlu!'); return; }
  await db.collection('employees').add({ name,dept,seniorityId:senId,cap,costTL, createdBy:S.currentUser.uid });
  document.getElementById('en').value=''; document.getElementById('ec').value='160'; document.getElementById('ek').value='';
}
async function delEmp(id) {
  if (!confirm('Silinsin mi?')) return;
  await db.collection('employees').doc(id).delete();
}
function renderEmps() {
  const tb = document.getElementById('emp-tb');
  document.getElementById('emp-cnt').textContent = S.employees.length+' Ã§alÄ±ÅŸan';
  if (!S.employees.length) { tb.innerHTML='<tr><td colspan="9"><div class="empty"><div class="ei">ğŸ‘¥</div><p>HenÃ¼z Ã§alÄ±ÅŸan eklenmedi</p></div></td></tr>'; return; }
  tb.innerHTML = S.employees.map(e => {
    const dC=dCap(e.dept), dU=dUsed(e.dept);
    const eu = dC>0 ? (dU/dC)*e.cap : 0;
    const p  = pct(eu,e.cap);
    const costActual = e.costTL * COST_MULTIPLIER;
    const hrEUR = e.cap>0 ? (costActual/S.eurTry)/e.cap : 0;
    return `<tr>
      <td><strong>${e.name}</strong></td>
      <td><span class="badge ${DB[e.dept]}">${DEPTS[e.dept]}</span></td>
      <td><span class="badge bneu">${seniorityName(e.seniorityId)}</span></td>
      <td>${fmtN(e.cap)} sa</td>
      <td><div style="display:flex;align-items:center;gap:6px">
        <div class="prog-track" style="width:60px"><div class="prog-fill ${fCls(p,e.dept)}" style="width:${p}%"></div></div>
        <span style="font-size:.7rem;color:var(--text2)">${p}%</span></div></td>
      <td style="color:var(--text2)">${e.costTL ? fmtT(e.costTL) : 'â€”'}</td>
      <td style="font-weight:600">${e.costTL ? fmtT(costActual) : 'â€”'}</td>
      <td style="color:var(--sw)">${hrEUR>0 ? 'â‚¬'+hrEUR.toFixed(2)+'/sa' : 'â€”'}</td>
      <td><button class="btn bg" onclick="delEmp('${e.id}')">âœ•</button></td>
    </tr>`;
  }).join('');
}

/* â•â•â•â• SERVICES â•â•â•â• */
async function addSvc() {
  const name = document.getElementById('sn').value.trim();
  const dept = document.getElementById('sd').value;
  const price= parseFloat(document.getElementById('sp').value)||0;
  const hours= parseInt(document.getElementById('sh').value)||0;
  if (!name||price<=0||hours<=0) { alert('TÃ¼m alanlarÄ± doldur!'); return; }
  await db.collection('services').add({ name,dept,priceEUR:price,hours, createdBy:S.currentUser.uid });
  document.getElementById('sn').value=''; document.getElementById('sp').value=''; document.getElementById('sh').value='';
}
async function delSvc(id) {
  if (!confirm('Silinsin mi?')) return;
  await db.collection('services').doc(id).delete();
}
function renderSvcs() {
  const tb = document.getElementById('svc-tb');
  if (!S.services.length) { tb.innerHTML='<tr><td colspan="9"><div class="empty"><div class="ei">ğŸ“‹</div><p>HenÃ¼z hizmet eklenmedi</p></div></td></tr>'; return; }
  tb.innerHTML = S.services.map(s => {
    const hrE = hrRateEUR(s.dept);
    const costEUR = s.hours * hrE;
    const expProfit = s.priceEUR / 3;
    const actProfit = s.priceEUR - costEUR;
    const margin = s.priceEUR>0 ? (actProfit/s.priceEUR)*100 : 0;
    const hrRev = s.hours>0 ? s.priceEUR/s.hours : 0;
    return `<tr>
      <td><strong>${s.name}</strong></td>
      <td><span class="badge ${DB[s.dept]}">${DEPTS[s.dept]}</span></td>
      <td style="font-weight:600">â‚¬${fmtN(s.priceEUR)}</td>
      <td style="color:var(--sw);font-weight:600">â‚¬${fmtN(expProfit)}</td>
      <td>${s.hours} sa</td>
      <td style="color:var(--text2)">â‚¬${hrRev.toFixed(1)}/sa</td>
      <td style="color:${hrE>0?mc(margin):'var(--text3)'};font-weight:600">${hrE>0?'â‚¬'+fmtN(actProfit):'â€”'}</td>
      <td style="color:${hrE>0?mc(margin):'var(--text3)'};font-weight:700">${hrE>0?Math.round(margin)+'%':'â€”'}</td>
      <td><button class="btn bg" onclick="delSvc('${s.id}')">âœ•</button></td>
    </tr>`;
  }).join('');
}

/* â•â•â•â• JOBS â•â•â•â• */
function syncJobSvcSelect() {
  const sel = document.getElementById('js'); const cur=sel.value;
  sel.innerHTML='<option value="">â€” Hizmet SeÃ§ â€”</option>'+
    S.services.map(s=>`<option value="${s.id}">${s.name} (${DEPTS[s.dept]})</option>`).join('');
  if(cur) sel.value=cur;
  sel.onchange=function(){
    const s=S.services.find(sv=>sv.id===this.value);
    if(s){document.getElementById('jr').value=s.priceEUR; document.getElementById('jh').value=s.hours;}
  };
}
async function addJob() {
  const client = document.getElementById('jc').value.trim();
  const sector = document.getElementById('jsec').value;
  const svcId  = document.getElementById('js').value;
  const rev    = parseFloat(document.getElementById('jr').value)||0;
  const hrs    = parseInt(document.getElementById('jh').value)||0;
  if (!client||!svcId||rev<=0||hrs<=0) { alert('TÃ¼m alanlarÄ± doldur!'); return; }
  const svc = S.services.find(s=>s.id===svcId); if(!svc) return;
  await db.collection('jobs').add({ client,sector,svcId,svcName:svc.name,dept:svc.dept,revEUR:rev,hrs, createdBy:S.currentUser.uid });
  document.getElementById('jc').value=''; document.getElementById('js').value=''; document.getElementById('jr').value=''; document.getElementById('jh').value='';
}
async function delJob(id) {
  if (!confirm('Silinsin mi?')) return;
  await db.collection('jobs').doc(id).delete();
}
function renderJobs() {
  const tb=document.getElementById('job-tb'), se=document.getElementById('j-sum');
  if (!S.jobs.length) { tb.innerHTML='<tr><td colspan="9"><div class="empty"><div class="ei">ğŸ—‚</div><p>HenÃ¼z iÅŸ eklenmedi</p></div></td></tr>'; se.textContent=''; return; }
  const tR=S.jobs.reduce((s,j)=>s+j.revEUR,0);
  se.innerHTML=`Toplam: <strong style="color:var(--green)">${fmtE(tR)}/ay</strong> Â· ${S.jobs.length} mÃ¼ÅŸteri`;
  tb.innerHTML = S.jobs.map(j => {
    const hrE=hrRateEUR(j.dept), cost=j.hrs*hrE;
    const profit=j.revEUR-cost;
    const margin=j.revEUR>0?(profit/j.revEUR)*100:0;
    return `<tr>
      <td><strong>${j.client}</strong></td>
      <td><span class="badge bneu" style="font-size:.62rem">${j.sector||'â€”'}</span></td>
      <td style="color:var(--text2)">${j.svcName}</td>
      <td><span class="badge ${DB[j.dept]}">${DEPTS[j.dept]}</span></td>
      <td style="color:var(--green);font-weight:600">${fmtE(j.revEUR)}</td>
      <td>${j.hrs} sa</td>
      <td style="color:${hrE>0?mc(margin):'var(--text3)'};font-weight:600">${hrE>0?fmtE(profit):'â€”'}</td>
      <td style="color:${hrE>0?mc(margin):'var(--text3)'};font-weight:700">${hrE>0?Math.round(margin)+'%':'â€”'}</td>
      <td><button class="btn bg" onclick="delJob('${j.id}')">âœ•</button></td>
    </tr>`;
  }).join('');
}

/* â•â•â•â• SECTOR ANALYSIS â•â•â•â• */
function getSectorData() {
  const sectors = {};
  S.jobs.forEach(j => {
    const sec = j.sector||'DiÄŸer';
    if (!sectors[sec]) sectors[sec]={name:sec,rev:0,cost:0,jobs:0};
    sectors[sec].rev += j.revEUR;
    sectors[sec].cost+= j.hrs * hrRateEUR(j.dept);
    sectors[sec].jobs++;
  });
  return Object.values(sectors).map(s=>({
    ...s, profit:s.rev-s.cost,
    margin: s.rev>0?((s.rev-s.cost)/s.rev)*100:0
  })).sort((a,b)=>b.profit-a.profit);
}

/* â•â•â•â• DASHBOARD â•â•â•â• */
function renderDash() {
  ['sw','cr','pm'].forEach(d => {
    const cap=dCap(d),used=dUsed(d),free=Math.max(0,cap-used);
    const p=pct(used,cap), emp=S.employees.filter(e=>e.dept===d).length, jobs=S.jobs.filter(j=>j.dept===d).length;
    const dRev=S.jobs.filter(j=>j.dept===d).reduce((s,j)=>s+j.revEUR,0);
    const dCostE=dCostEUR(d);
    const dProfit=dRev-dCostE;
    document.getElementById(`d-${d}-e`).textContent=emp+' kiÅŸi';
    document.getElementById(`d-${d}-p`).textContent=p+'%';
    document.getElementById(`d-${d}-b`).style.width=p+'%';
    document.getElementById(`d-${d}-b`).className='prog-fill '+fCls(p,d);
    document.getElementById(`d-${d}-i`).textContent=`${fmtN(free)} sa boÅŸta Â· ${jobs} iÅŸ`;
    document.getElementById(`d-${d}-rev`).textContent=fmtE(dRev);
    document.getElementById(`d-${d}-profit`).textContent=fmtE(dProfit);
    document.getElementById(`d-${d}-profit`).style.color=dProfit>=0?'var(--green)':'var(--red)';
  });

  const tCap=['sw','cr','pm'].reduce((s,d)=>s+dCap(d),0);
  const tUsed=['sw','cr','pm'].reduce((s,d)=>s+dUsed(d),0);
  const tRev=S.jobs.reduce((s,j)=>s+j.revEUR,0);
  const tCost=['sw','cr','pm'].reduce((s,d)=>s+dCostEUR(d),0);
  const profit=tRev-tCost;
  document.getElementById('d-tcap').textContent=fmtN(tCap);
  document.getElementById('d-ucap').textContent=fmtN(tUsed);
  document.getElementById('d-rev').textContent=fmtE(tRev);
  const pe=document.getElementById('d-profit');
  pe.textContent=fmtE(profit);
  pe.style.color=profit>=0?'var(--green)':'var(--red)';

  // Best / worst dept
  const deptStats = ['sw','cr','pm'].map(d=>({
    d, rev:S.jobs.filter(j=>j.dept===d).reduce((s,j)=>s+j.revEUR,0),
    profit: S.jobs.filter(j=>j.dept===d).reduce((s,j)=>s+j.revEUR,0) - dCostEUR(d)
  })).sort((a,b)=>b.profit-a.profit);

  const bestDept=deptStats[0], worstDept=deptStats[deptStats.length-1];
  document.getElementById('d-best-dept').innerHTML = bestDept && bestDept.rev>0
    ? `<div style="display:flex;align-items:center;gap:8px;padding:10px;background:var(--green-s);border-radius:var(--rsm);margin-bottom:10px">
        <span style="font-size:1.2rem">ğŸ†</span>
        <div><div style="font-weight:700;font-size:.84rem">${DEPTS[bestDept.d]}</div>
        <div style="font-size:.72rem;color:var(--text2)">${fmtE(bestDept.rev)} gelir Â· ${fmtE(bestDept.profit)} kÃ¢r</div></div>
       </div>` : '';
  document.getElementById('d-worst-dept').innerHTML = worstDept && worstDept.profit < 0
    ? `<div style="display:flex;align-items:center;gap:8px;padding:10px;background:var(--red-s);border-radius:var(--rsm);margin-bottom:10px">
        <span style="font-size:1.2rem">âš ï¸</span>
        <div><div style="font-weight:700;font-size:.84rem">${DEPTS[worstDept.d]}</div>
        <div style="font-size:.72rem;color:var(--text2)">${fmtE(worstDept.rev)} gelir Â· ${fmtE(worstDept.profit)} kÃ¢r</div></div>
       </div>` : '';

  // Sectors
  const sectors = getSectorData();
  const pos = sectors.filter(s=>s.margin>20);
  const neg = sectors.filter(s=>s.margin<=20);
  const sectorIcons = {'Turizm & Otel':'ğŸ¨','E-ticaret':'ğŸ›’','Ä°nÅŸaat & GYO':'ğŸ—','Tekstil & Moda':'ğŸ‘—','GÄ±da & Ä°Ã§ecek':'ğŸ½','SaÄŸlÄ±k':'ğŸ¥','EÄŸitim':'ğŸ“š','Teknoloji':'ğŸ’»','Otomotiv':'ğŸš—','Perakende':'ğŸª','Finans':'ğŸ¦','DiÄŸer':'ğŸ“Œ'};

  document.getElementById('d-sectors-pos').innerHTML = pos.length
    ? pos.map(s=>`<div class="sec-card">
        <div class="sec-icon" style="background:var(--green-s)">${sectorIcons[s.name]||'ğŸ“Œ'}</div>
        <div class="sec-info"><div class="sec-name">${s.name}</div><div class="sec-sub">${s.jobs} mÃ¼ÅŸteri Â· ${fmtE(s.rev)} gelir</div></div>
        <div><div class="sec-val" style="color:var(--green)">${fmtE(s.profit)}</div><div class="sec-pct">%${Math.round(s.margin)} marj</div></div>
      </div>`).join('')
    : '<div style="font-size:.78rem;color:var(--text3);padding:8px 0">Veri yok</div>';

  document.getElementById('d-sectors-neg').innerHTML = neg.length
    ? neg.map(s=>`<div class="sec-card">
        <div class="sec-icon" style="background:${s.margin<0?'var(--red-s)':'var(--amber-s)'}">${sectorIcons[s.name]||'ğŸ“Œ'}</div>
        <div class="sec-info"><div class="sec-name">${s.name}</div><div class="sec-sub">${s.jobs} mÃ¼ÅŸteri Â· ${fmtE(s.rev)} gelir</div></div>
        <div><div class="sec-val" style="color:${s.margin<0?'var(--red)':'var(--amber)'}">${fmtE(s.profit)}</div><div class="sec-pct">%${Math.round(s.margin)} marj</div></div>
      </div>`).join('')
    : '<div style="font-size:.78rem;color:var(--text3);padding:8px 0">TÃ¼m sektÃ¶rler kÃ¢rlÄ± ğŸ‰</div>';

  // Quick rec
  const rec=document.getElementById('d-rec');
  if (!S.services.length||!S.employees.length) { rec.textContent='Veri giriÅŸi yapÄ±nca otomatik Ã¶neri gÃ¶rÃ¼nÃ¼r.'; return; }
  const opps=getOpps();
  if (!opps.length) { rec.innerHTML='<span style="color:var(--amber)">TÃ¼m departmanlar kapasitede.</span>'; return; }
  const t=opps[0];
  rec.innerHTML=`<strong>${t.name}</strong> <span class="badge ${DB[t.dept]}" style="margin:0 4px">${DEPTS[t.dept]}</span> â€” <strong>${t.slots} yeni mÃ¼ÅŸteri</strong> kapasiten var, her biri <strong style="color:var(--green)">${fmtE(t.profitEach)}/ay</strong> katkÄ± marjÄ±.`;
}

/* â•â•â•â• OPPORTUNITIES â•â•â•â• */
function getOpps() {
  return S.services.map(svc => {
    const cap=dCap(svc.dept), used=dUsed(svc.dept), free=Math.max(0,cap-used);
    if(free<=0) return null;
    const hrE=hrRateEUR(svc.dept), cost=svc.hours*hrE, profit=svc.priceEUR-cost;
    const margin=svc.priceEUR>0?(profit/svc.priceEUR)*100:0;
    const slots=svc.hours>0?Math.floor(free/svc.hours):0;
    if(slots<=0) return null;
    const score=(profit/svc.hours)*free;
    return{...svc,free,cost,profit,margin,slots,profitEach:profit,score,sl:margin>55?'YÃ¼ksek':margin>20?'Orta':'DÃ¼ÅŸÃ¼k'};
  }).filter(Boolean).sort((a,b)=>b.score-a.score);
}

/* â•â•â•â• TIME REDUCTION SUGGESTIONS â•â•â•â• */
function getTimeReductions() {
  const suggestions = [];
  S.jobs.forEach(j => {
    const svc = S.services.find(s=>s.id===j.svcId);
    if (!svc) return;
    if (j.hrs <= svc.hours) return; // already at or under standard
    const excess = j.hrs - svc.hours;
    const hrE = hrRateEUR(j.dept);
    const currentCost = j.hrs * hrE;
    const optimizedCost = svc.hours * hrE;
    const profitGain = currentCost - optimizedCost; // savings
    const currentMargin = j.revEUR>0?((j.revEUR-currentCost)/j.revEUR)*100:0;
    const optimizedMargin = j.revEUR>0?((j.revEUR-optimizedCost)/j.revEUR)*100:0;
    const freedHours = excess;
    suggestions.push({
      client:j.client, sector:j.sector, svcName:j.svcName, dept:j.dept,
      currentHrs:j.hrs, standardHrs:svc.hours, excessHrs:excess,
      profitGain, freedHours, currentMargin, optimizedMargin,
      score: profitGain * 12 // annualized
    });
  });
  return suggestions.sort((a,b)=>b.score-a.score);
}

/* â•â•â•â• BLEND PACKAGES â•â•â•â• */
function getBlendOpps() {
  const pairs = [];
  for (let i=0; i<S.services.length; i++) {
    for (let j=i+1; j<S.services.length; j++) {
      const s1=S.services[i], s2=S.services[j];
      const free1=Math.max(0,dCap(s1.dept)-dUsed(s1.dept));
      const free2=Math.max(0,dCap(s2.dept)-dUsed(s2.dept));
      if(free1<s1.hours||free2<s2.hours) continue;
      const slots=Math.min(Math.floor(free1/s1.hours),Math.floor(free2/s2.hours));
      if(slots<=0) continue;
      const totalPrice=s1.priceEUR+s2.priceEUR;
      const discPrice=totalPrice*0.95; // 5% package discount
      const costEUR=(s1.hours*hrRateEUR(s1.dept))+(s2.hours*hrRateEUR(s2.dept));
      const profit=discPrice-costEUR;
      const margin=discPrice>0?(profit/discPrice)*100:0;
      const score=profit*slots;
      if(profit<=0) continue;
      pairs.push({type:'pair',services:[s1,s2],totalPrice,discPrice,costEUR,profit,margin,slots,score,discount:totalPrice-discPrice});
    }
  }
  // Upsell: existing clients with additional services
  const upsells = [];
  const clientMap = {};
  S.jobs.forEach(j=>{
    if(!clientMap[j.client]) clientMap[j.client]={client:j.client,sector:j.sector,svcIds:[]};
    clientMap[j.client].svcIds.push(j.svcId);
  });
  Object.values(clientMap).forEach(cm=>{
    S.services.forEach(svc=>{
      if(cm.svcIds.includes(svc.id)) return;
      const free=Math.max(0,dCap(svc.dept)-dUsed(svc.dept));
      if(free<svc.hours) return;
      const hrE=hrRateEUR(svc.dept);
      const cost=svc.hours*hrE, profit=svc.priceEUR-cost;
      const margin=svc.priceEUR>0?(profit/svc.priceEUR)*100:0;
      if(profit<=0) return;
      upsells.push({type:'upsell',client:cm.client,sector:cm.sector,service:svc,profit,margin,score:profit*12});
    });
  });
  return {
    pairs: pairs.sort((a,b)=>b.score-a.score).slice(0,8),
    upsells: upsells.sort((a,b)=>b.score-a.score).slice(0,8)
  };
}

/* â•â•â•â• ANALYSIS: TEKIL â•â•â•â• */
function renderAnTekil() {
  const el=document.getElementById('an-tekil');
  if (!S.employees.length||!S.services.length) {
    el.innerHTML='<div class="card"><div class="empty"><div class="ei">ğŸ“ˆ</div><p>Ä°ÅŸ gÃ¼cÃ¼ ve hizmet verisi gerekiyor.</p></div></div>'; return;
  }
  const opps=getOpps(), reductions=getTimeReductions();
  const maxS=opps.length?opps[0].score:1;
  const topRec=opps.length
    ?`<div class="hbox green"><div class="ht">ğŸ¯ Ã–ncelikli Yeni MÃ¼ÅŸteri FÄ±rsatÄ±</div><div class="hb">
      <span class="badge ${DB[opps[0].dept]}" style="margin-right:5px">${DEPTS[opps[0].dept]}</span>
      departmanÄ±nda <strong>${fmtN(opps[0].free)} sa</strong> boÅŸ. <strong>${opps[0].name}</strong> iÃ§in <strong>${opps[0].slots} yeni mÃ¼ÅŸteri</strong> kapasitesi var.
      Her biri aylÄ±k <strong>${fmtE(opps[0].profitEach)}</strong> katkÄ± â†’ yÄ±llÄ±k potansiyel <strong>${fmtE(opps[0].profitEach*opps[0].slots*12)}</strong>.
     </div></div>`
    :`<div class="hbox amber"><div class="ht">âš  TÃ¼m departmanlar kapasitede</div><div class="hb">Yeni iÅŸ almak iÃ§in Ã§alÄ±ÅŸan eklemeyi deÄŸerlendir.</div></div>`;

  const oppCards=opps.map((o,i)=>{
    const sw=(o.score/maxS)*100;
    const ac=i===0?'var(--green)':i===1?'var(--sw)':i===2?'var(--cr)':'var(--border2)';
    return `<div class="ocard">
      <div class="ocard-accent" style="background:${ac}"></div>
      <div class="ocard-rank">${['#1','#2','#3'][i]||'#'+(i+1)}</div>
      <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap;margin-bottom:4px">
        <div class="ocard-name">${o.name}</div>
        <span class="badge ${DB[o.dept]}">${DEPTS[o.dept]}</span>
        <span class="badge ${mcBadge(o.margin)}">${Math.round(o.margin)}% marj</span>
      </div>
      <div style="font-size:.76rem;color:var(--text2)">Kapasite: <strong style="color:var(--text)">${o.slots} yeni mÃ¼ÅŸteri alÄ±nabilir</strong></div>
      <div class="om-grid">
        <div class="om-item"><div class="om-l">Fiyat/Ay</div><div class="om-v" style="color:var(--sw)">${fmtE(o.priceEUR)}</div></div>
        <div class="om-item"><div class="om-l">KÃ¢r/MÃ¼ÅŸteri</div><div class="om-v" style="color:var(--green)">${fmtE(o.profitEach)}</div></div>
        <div class="om-item"><div class="om-l">Toplam Potansiyel</div><div class="om-v" style="color:var(--green)">${fmtE(o.profitEach*o.slots)}</div></div>
        <div class="om-item"><div class="om-l">BoÅŸ Kapasite</div><div class="om-v">${fmtN(o.free)} sa</div></div>
      </div>
      <div class="sbar"><div class="sfill" style="width:${sw}%"></div></div>
    </div>`;
  }).join('');

  const redCards = reductions.length ? reductions.map(r=>`
    <div class="ocard" style="border-color:var(--amber-b)">
      <div class="ocard-accent" style="background:var(--amber)"></div>
      <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap;margin-bottom:6px">
        <div class="ocard-name">âš¡ ${r.client}</div>
        <span class="badge bneu" style="font-size:.6rem">${r.sector||''}</span>
        <span class="badge ${DB[r.dept]}">${DEPTS[r.dept]}</span>
      </div>
      <div style="font-size:.78rem;color:var(--text2);margin-bottom:10px">
        <strong>${r.svcName}</strong> iÃ§in standart sÃ¼re <strong>${r.standardHrs} sa</strong> â€” ÅŸu an <strong style="color:var(--amber)">${r.currentHrs} sa</strong> ayrÄ±lÄ±yor (<strong>+${r.excessHrs} sa fazla</strong>)
      </div>
      <div class="om-grid">
        <div class="om-item"><div class="om-l">KazanÄ±lacak KÃ¢r/Ay</div><div class="om-v" style="color:var(--green)">${fmtE(r.profitGain)}</div></div>
        <div class="om-item"><div class="om-l">KazanÄ±lacak KÃ¢r/YÄ±l</div><div class="om-v" style="color:var(--green)">${fmtE(r.profitGain*12)}</div></div>
        <div class="om-item"><div class="om-l">Serbest Kalacak Saat</div><div class="om-v">${r.freedHours} sa/ay</div></div>
        <div class="om-item"><div class="om-l">Marj: Åu An â†’ Hedef</div><div class="om-v">${Math.round(r.currentMargin)}% â†’ <span style="color:var(--green)">${Math.round(r.optimizedMargin)}%</span></div></div>
      </div>
    </div>`).join('')
    : '<div class="empty"><div class="ei">âœ…</div><p>TÃ¼m iÅŸler standart sÃ¼rede yÃ¼rÃ¼tÃ¼lÃ¼yor</p></div>';

  // Dept capacity
  const dCards=['sw','cr','pm'].map(d=>{
    const cap=dCap(d),used=dUsed(d),free=Math.max(0,cap-used),p=pct(used,cap);
    const st=p>90?'<span class="badge bfull">Dolu</span>':p>60?'<span class="badge bwarn">Orta</span>':'<span class="badge bok">BoÅŸta</span>';
    return `<div class="dept-card" style="margin-bottom:0">
      <div class="dept-head"><div class="dept-name"><span class="dd ${d}"></span>${DEPTS[d]}</div>${st}</div>
      <div class="prog-meta"><span>${fmtN(used)}/${fmtN(cap)} sa</span><span>${p}%</span></div>
      <div class="prog-track"><div class="prog-fill ${fCls(p,d)}" style="width:${p}%"></div></div>
      <div class="prog-sub">${fmtN(free)} sa boÅŸ Â· ${S.employees.filter(e=>e.dept===d).length} Ã§alÄ±ÅŸan</div>
    </div>`;
  }).join('');

  el.innerHTML=`
    ${topRec}
    <div class="card"><div class="card-title">Departman Kapasite Durumu</div><div class="g3">${dCards}</div></div>
    <div class="card"><div style="margin-bottom:12px"><div class="card-title" style="margin-bottom:2px">Yeni MÃ¼ÅŸteri FÄ±rsatlarÄ±</div><div style="font-size:.7rem;color:var(--text3)">FÄ±rsat Skoru = Sa BaÅŸÄ± KÃ¢r Ã— BoÅŸ Kapasite</div></div>${oppCards||'<div class="empty"><p>BoÅŸ kapasite yok</p></div>'}</div>
    <div class="card"><div style="margin-bottom:12px"><div class="card-title" style="margin-bottom:2px">âš¡ SÃ¼re Optimizasyonu</div><div style="font-size:.7rem;color:var(--text3)">Standart sÃ¼reden fazla harcanan iÅŸlerde kÃ¢rlÄ±lÄ±k artÄ±ÅŸ potansiyeli</div></div>${redCards}</div>`;
}

/* â•â•â•â• ANALYSIS: BLEND â•â•â•â• */
function renderAnBlend() {
  const el=document.getElementById('an-blend');
  if (!S.employees.length||!S.services.length) {
    el.innerHTML='<div class="card"><div class="empty"><div class="ei">ğŸ“¦</div><p>Veri giriÅŸi gerekiyor.</p></div></div>'; return;
  }
  const {pairs, upsells} = getBlendOpps();

  const pairCards = pairs.length ? pairs.map((p,i)=>{
    const ac=i===0?'var(--green)':i===1?'var(--sw)':'var(--border2)';
    return `<div class="ocard">
      <div class="ocard-accent" style="background:${ac}"></div>
      <div class="ocard-rank">#${i+1}</div>
      <div class="ocard-name" style="margin-bottom:6px">ğŸ“¦ ${p.services[0].name} + ${p.services[1].name}</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">
        <span class="badge ${DB[p.services[0].dept]}">${DEPTS[p.services[0].dept]}</span>
        <span class="badge ${DB[p.services[1].dept]}">${DEPTS[p.services[1].dept]}</span>
        <span class="badge bwarn">%5 paket indirimi</span>
      </div>
      <div style="font-size:.76rem;color:var(--text2);margin-bottom:2px">
        Standart fiyat: <span style="text-decoration:line-through;color:var(--text3)">${fmtE(p.totalPrice)}</span>
        â†’ <strong style="color:var(--sw)">${fmtE(p.discPrice)}</strong> paket fiyatÄ±
      </div>
      <div class="om-grid">
        <div class="om-item"><div class="om-l">KÃ¢r / Paket</div><div class="om-v" style="color:var(--green)">${fmtE(p.profit)}</div></div>
        <div class="om-item"><div class="om-l">Marj</div><div class="om-v" style="color:${mc(p.margin)}">${Math.round(p.margin)}%</div></div>
        <div class="om-item"><div class="om-l">Maks. Paket SayÄ±sÄ±</div><div class="om-v">${p.slots} mÃ¼ÅŸteri</div></div>
        <div class="om-item"><div class="om-l">Toplam Potansiyel</div><div class="om-v" style="color:var(--green)">${fmtE(p.profit*p.slots)}</div></div>
      </div>
    </div>`;
  }).join('') : '<div class="empty"><div class="ei">ğŸ“¦</div><p>Paket iÃ§in yeterli boÅŸ kapasite bulunamadÄ±</p></div>';

  const upsellCards = upsells.length ? upsells.map((u,i)=>`
    <div class="ocard" style="border-color:var(--sw-b)">
      <div class="ocard-accent" style="background:var(--sw)"></div>
      <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap;margin-bottom:6px">
        <div class="ocard-name">ğŸ”„ ${u.client}</div>
        <span class="badge bneu" style="font-size:.6rem">${u.sector||''}</span>
      </div>
      <div style="font-size:.78rem;color:var(--text2);margin-bottom:8px">
        Mevcut mÃ¼ÅŸteriye ek hizmet Ã¶nerisi: <strong>${u.service.name}</strong>
        <span class="badge ${DB[u.service.dept]}" style="margin-left:5px">${DEPTS[u.service.dept]}</span>
      </div>
      <div class="om-grid">
        <div class="om-item"><div class="om-l">Fiyat</div><div class="om-v" style="color:var(--sw)">${fmtE(u.service.priceEUR)}</div></div>
        <div class="om-item"><div class="om-l">KatkÄ± MarjÄ±</div><div class="om-v" style="color:${mc(u.margin)}">${Math.round(u.margin)}%</div></div>
        <div class="om-item"><div class="om-l">AylÄ±k KÃ¢r</div><div class="om-v" style="color:var(--green)">${fmtE(u.profit)}</div></div>
        <div class="om-item"><div class="om-l">YÄ±llÄ±k KÃ¢r</div><div class="om-v" style="color:var(--green)">${fmtE(u.profit*12)}</div></div>
      </div>
    </div>`).join('')
    : '<div class="empty"><div class="ei">ğŸ”„</div><p>TÃ¼m mÃ¼ÅŸteriler mevcut hizmetlere sahip veya kapasite yok</p></div>';

  // Sector blend: which sectors have growth potential?
  const sectorData = getSectorData();
  const sectorOpp = sectorData.filter(s=>s.margin>30).map(s=>`
    <div class="ocard" style="border-color:var(--pm-b)">
      <div class="ocard-accent" style="background:var(--pm)"></div>
      <div style="display:flex;align-items:center;gap:7px;margin-bottom:6px">
        <div class="ocard-name">ğŸŒ ${s.name} SektÃ¶rÃ¼</div>
        <span class="badge bok">${Math.round(s.margin)}% marj</span>
      </div>
      <div style="font-size:.78rem;color:var(--text2);margin-bottom:8px">${s.jobs} aktif mÃ¼ÅŸteri Â· ${fmtE(s.rev)} toplam gelir Â· ${fmtE(s.profit)} kÃ¢r</div>
      <div class="hbox green" style="margin:0;padding:10px 12px">
        <div class="hb">Bu sektÃ¶rde gÃ¼Ã§lÃ¼ marjÄ±nÄ±z var. Benzer sektÃ¶rdeki yeni mÃ¼ÅŸterilere Ã¶ncelik verin â€” Ã¶ÄŸrenme eÄŸrisi avantajÄ± satÄ±ÅŸ dÃ¶ngÃ¼sÃ¼nÃ¼ kÄ±saltÄ±r.</div>
      </div>
    </div>`).join('');

  el.innerHTML=`
    <div class="card"><div style="margin-bottom:12px"><div class="card-title" style="margin-bottom:2px">ğŸ“¦ Ã‡apraz Hizmet Paket Ã–nerileri</div><div style="font-size:.7rem;color:var(--text3)">Ä°ki hizmeti birlikte satarak %5 indirimli paket â€” mÃ¼ÅŸteri kazanÄ±r, marjÄ±n korunur</div></div>${pairCards}</div>
    <div class="card"><div style="margin-bottom:12px"><div class="card-title" style="margin-bottom:2px">ğŸ”„ Mevcut MÃ¼ÅŸteriye Ek Hizmet (Upsell)</div><div style="font-size:.7rem;color:var(--text3)">Mevcut mÃ¼ÅŸterilere henÃ¼z sunulmayan hizmetler</div></div>${upsellCards}</div>
    ${sectorOpp ? `<div class="card"><div style="margin-bottom:12px"><div class="card-title" style="margin-bottom:2px">ğŸŒ SektÃ¶r BazlÄ± BÃ¼yÃ¼me Ã–nerileri</div></div>${sectorOpp}</div>` : ''}`;
}

/* â•â•â•â• PROFITABILITY â•â•â•â• */
function renderPr() {
  const el=document.getElementById('pr-root');
  if(!S.services.length){el.innerHTML='<div class="card"><div class="empty"><div class="ei">ğŸ’°</div><p>Hizmet verisi gerekiyor.</p></div></div>';return;}
  const hasR=S.employees.length>0;
  const tRev=S.jobs.reduce((s,j)=>s+j.revEUR,0);
  const tCost=['sw','cr','pm'].reduce((s,d)=>s+dCostEUR(d),0);
  const net=tRev-tCost; const nm=tRev>0?(net/tRev)*100:0;

  const sdata=S.services.map(s=>{
    const hrE=hrRateEUR(s.dept), cost=s.hours*hrE, profit=s.priceEUR-cost;
    const margin=s.priceEUR>0?(profit/s.priceEUR)*100:0;
    const expProfit=s.priceEUR/3;
    const jobs=S.jobs.filter(j=>j.svcId===s.id);
    const aRev=jobs.reduce((x,j)=>x+j.revEUR,0);
    return{...s,cost,profit,expProfit,margin,jobCount:jobs.length,aRev};
  }).sort((a,b)=>b.margin-a.margin);
  const maxM=Math.max(...sdata.map(s=>s.margin),100);

  const rows=sdata.map((s,i)=>{
    const mC=hasR?mc(s.margin):'var(--text3)';
    const bw=hasR?Math.max(0,(s.margin/maxM)*100):0;
    return `<tr>
      <td><div style="display:flex;align-items:center;gap:6px">
        <span style="font-size:.68rem;font-weight:700;color:var(--text3);width:18px">${i+1}</span>
        <div><strong>${s.name}</strong><br><span class="badge ${DB[s.dept]}" style="margin-top:3px">${DEPTS[s.dept]}</span></div>
      </div></td>
      <td style="font-weight:600">${fmtE(s.priceEUR)}</td>
      <td style="color:var(--sw)">${fmtE(s.expProfit)}</td>
      <td>${hasR?fmtE(s.cost):'â€”'}</td>
      <td style="color:var(--green);font-weight:600">${hasR?fmtE(s.profit):'â€”'}</td>
      <td><div style="display:flex;align-items:center;gap:6px">
        <div class="prog-track" style="width:52px"><div style="height:100%;width:${bw}%;background:${mC};border-radius:99px"></div></div>
        <span style="color:${mC};font-weight:700">${hasR?Math.round(s.margin)+'%':'â€”'}</span>
      </div></td>
      <td style="color:var(--text2);text-align:center">${s.jobCount}</td>
      <td style="color:var(--sw);font-weight:600">${s.jobCount>0?fmtE(s.aRev):'â€”'}</td>
    </tr>`;
  }).join('');

  // Sector table
  const sectors=getSectorData();
  const secRows=sectors.map(s=>`<tr>
    <td><strong>${s.name}</strong></td>
    <td>${s.jobs}</td>
    <td style="color:var(--green);font-weight:600">${fmtE(s.rev)}</td>
    <td>${fmtE(s.cost)}</td>
    <td style="color:${mc(s.margin)};font-weight:700">${fmtE(s.profit)}</td>
    <td><span class="badge ${mcBadge(s.margin)}">${Math.round(s.margin)}%</span></td>
  </tr>`).join('');

  el.innerHTML=`
    <div class="g3" style="margin-bottom:14px">
      <div class="stat"><div class="sl">AylÄ±k Gelir</div><div class="sv" style="color:var(--green)">${fmtE(tRev)}</div><div class="ss">${S.jobs.length} aktif iÅŸ</div></div>
      <div class="stat"><div class="sl">Ä°ÅŸgÃ¼cÃ¼ Maliyeti</div><div class="sv">${fmtE(tCost)}</div><div class="ss">${S.employees.length} Ã§alÄ±ÅŸan (Ã—1,3)</div></div>
      <div class="stat"><div class="sl">Net KÃ¢r / Marj</div>
        <div class="sv" style="color:${net>=0?'var(--green)':'var(--red)'}">${fmtE(net)}</div>
        <div class="ss" style="color:${net>=0?'var(--green)':'var(--red)'}">${hasR&&tRev>0?Math.round(nm)+'%':'â€”'}</div>
      </div>
    </div>
    <div class="card">
      <div style="margin-bottom:12px"><div class="card-title" style="margin-bottom:2px">Hizmet KÃ¢rlÄ±lÄ±k SÄ±ralamasÄ±</div>
        <div style="font-size:.68rem;color:var(--text3)">Beklenen kÃ¢r = fiyatÄ±n 1/3'Ã¼ Â· GerÃ§ekleÅŸen kÃ¢r = fiyat âˆ’ (saat Ã— sa baÅŸÄ± EUR maliyet)</div>
      </div>
      <div class="tw"><table>
        <thead><tr><th>Hizmet</th><th>Fiyat/Ay</th><th>Bekl. KÃ¢r</th><th>Maliyet*</th><th>GerÃ§. KÃ¢r*</th><th>Marj %</th><th>MÃ¼ÅŸteri</th><th>Aktif Gelir</th></tr></thead>
        <tbody>${rows}</tbody>
      </table></div>
    </div>
    <div class="card">
      <div class="card-title" style="margin-bottom:12px">SektÃ¶r KÃ¢rlÄ±lÄ±k Tablosu</div>
      <div class="tw"><table>
        <thead><tr><th>SektÃ¶r</th><th>MÃ¼ÅŸteri</th><th>Gelir</th><th>Maliyet</th><th>KÃ¢r</th><th>Marj</th></tr></thead>
        <tbody>${secRows||'<tr><td colspan="6"><div class="empty"><p>Ä°ÅŸlere sektÃ¶r atandÄ±ÄŸÄ±nda burada gÃ¶rÃ¼nÃ¼r</p></div></td></tr>'}</tbody>
      </table></div>
    </div>
    ${!hasR?'<div class="hbox amber"><div class="ht">âš  Maliyet verisi eksik</div><div class="hb">KÃ¢r marjÄ± hesaplamasÄ± iÃ§in Ã§alÄ±ÅŸan maliyetlerini gir.</div></div>':''}`;
}
</script>
</body>
</html>
